<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
        rel="stylesheet"
    />
    <!-- Pastikan file style.css Anda ada di direktori yang sama -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* Tambahkan gaya kustom jika diperlukan, misalnya untuk tabel responsif */
        .suppliers-table-wrapper, .history-table-wrapper {
            overflow-x: auto; /* Memungkinkan scrolling horizontal untuk tabel pada layar kecil */
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="navbar navbar-light">
            <button id="hamburger-btn" aria-label="Open Sidebar" tabindex="0">
                <i class="bi bi-list"></i>
            </button>
            <div class="header-icons">
                <button class="btn-bell" type="button" aria-label="Notifications" title="Notifications">
                    <i class="bi bi-bell"></i>
                </button>
                <button type="button" aria-label="User profile" title="User profile" class="p-0 border-0 bg-transparent">
                    <img
                        alt="User avatar icon, placeholder image"
                        src="https://storage.googleapis.com/a1aa/image/397a00f8-075d-4b23-9bff-bdc5eec82293.jpg"
                        width="32"
                        height="32"
                        class="rounded-circle"
                    />
                </button>
            </div>
        </nav>

        <div class="content-wrapper">
            <nav id="sidebar" class="sidebar" aria-label="Sidebar navigation">
                <ul>
                    <li>
                        <a href="home.html" class="inactive" data-tooltip="Home" tabindex="0">
                            <i class="bi bi-house"></i><span>Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="inventory.html" class="inactive" data-tooltip="Inventory" tabindex="0">
                            <i class="bi bi-box-seam"></i><span>Inventory</span>
                        </a>
                    </li>
                    <li>
                        <a href="suppliers.html" class="active" data-tooltip="Suppliers" tabindex="0">
                            <i class="bi bi-truck"></i><span>Suppliers</span>
                        </a>
                    </li>
                    <li>
                        <a href="sales.html" class="inactive" data-tooltip="Sales" tabindex="0">
                            <i class="bi bi-coin"></i><span>Sales</span>
                        </a>
                    </li>
                    <li>
                        <a href="report.html" class="inactive" data-tooltip="Reports" tabindex="0">
                            <i class="bi bi-file-earmark-text"></i><span>Reports</span>
                        </a>
                    </li>
                    <li>
                        <a href="staff.html" class="inactive" data-tooltip="Staff" tabindex="0">
                            <i class="bi bi-people"></i><span>Staff</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
            <main role="main" tabindex="0">
                <div class="container-fluid">
                    <h2 class="fw-bold mt-3">Suppliers</h2>
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                        <div class="input-group flex-grow-1" style="min-width: 250px; max-width: 400px;">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search"></i>
                            </span>
                            <!-- Input pencarian untuk pemasok -->
                            <input type="text" id="supplierSearchInput" class="form-control border-start-0" placeholder="Cari supplier..." />
                        </div>
                        <!-- Tombol Tambah Supplier, memicu modal -->
                        <button class="btn btn-primary btn-sm flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addSupplierModal">+ Tambah Supplier</button>
                    </div>

                    <div class="suppliers-table-wrapper">
                        <table class="table table-hover table-bordered rounded suppliers-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Supplier ID</th>
                                    <th>Nama Supplier</th>
                                    <th>Nama Kontak</th>
                                    <th>Nomor Telepon</th>
                                    <th>Alamat</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTableBody">
                                <!-- Data pemasok akan dimuat di sini oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <h3 class="fw-semibold mb-3">Riwayat Barang Masuk</h3>

                    <div class="d-flex flex-wrap filter-row mb-3 align-items-center gap-2">
                        <div class="input-group" style="min-width: 250px; max-width: 350px;">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search"></i>
                            </span>
                            <!-- Input pencarian untuk nama produk riwayat barang masuk -->
                            <input type="text" id="goodsInProductSearchInput" class="form-control border-start-0" placeholder="Cari nama produk..." />
                        </div>

                        <!-- Input filter tanggal riwayat barang masuk -->
                        <input type="date" id="goodsInDateFilter" class="form-control form-control-sm" style="max-width: 180px;" placeholder="Filter berdasarkan tanggal" />

                        <!-- Dropdown filter supplier ID riwayat barang masuk -->
                        <select id="goodsInSupplierFilter" class="form-select form-select-sm" style="max-width: 180px;">
                            <option value="">Filter berdasarkan Supplier ID</option>
                            <!-- ID Supplier akan diisi di sini oleh JavaScript -->
                        </select>

                        <!-- Tombol Tambah Data Riwayat Barang Masuk, memicu modal -->
                        <button class="btn btn-primary btn-sm flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addGoodsInModal">+ Tambah Data</button>
                    </div>

                    <div class="history-table-wrapper">
                        <table class="table table-hover table-bordered rounded">
                            <thead class="table-light">
                                <tr>
                                    <th>ID Barang Masuk</th>
                                    <th>ID Supplier</th>
                                    <th>ID Produk</th>
                                    <th>Nama Produk</th>
                                    <th>Tanggal Tiba</th>
                                    <th>Kuantitas</th>
                                    <th>Harga Satuan</th>
                                    <th>Total Biaya</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="goodsInHistoryTableBody">
                                <!-- Data riwayat barang masuk akan dimuat di sini oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->

    <!-- Modal Tambah Supplier -->
    <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSupplierModalLabel">Tambah Supplier Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <form id="addSupplierForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addSupplierId" class="form-label">Supplier ID</label>
                            <input type="text" class="form-control" id="addSupplierId" name="supplier_id" required>
                        </div>
                        <div class="mb-3">
                            <label for="addSupplierName" class="form-label">Nama Supplier</label>
                            <input type="text" class="form-control" id="addSupplierName" name="supplier_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="addContactName" class="form-label">Nama Kontak</label>
                            <input type="text" class="form-control" id="addContactName" name="contact_name">
                        </div>
                        <div class="mb-3">
                            <label for="addPhoneNumber" class="form-label">Nomor Telepon</label>
                            <input type="text" class="form-control" id="addPhoneNumber" name="phone_number">
                        </div>
                        <div class="mb-3">
                            <label for="addAddress" class="form-label">Alamat</label>
                            <textarea class="form-control" id="addAddress" name="address"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Edit Supplier -->
    <div class="modal fade" id="editSupplierModal" tabindex="-1" aria-labelledby="editSupplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSupplierModalLabel">Edit Supplier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <form id="editSupplierForm">
                    <div class="modal-body">
                        <input type="hidden" id="editSupplierOriginalId" name="supplier_id"> <!-- ID asli untuk query UPDATE -->
                        <div class="mb-3">
                            <label for="editSupplierId" class="form-label">Supplier ID</label>
                            <!-- ID ditampilkan tapi dinonaktifkan agar tidak bisa diubah -->
                            <input type="text" class="form-control" id="editSupplierId" name="supplier_id_display" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="editSupplierName" class="form-label">Nama Supplier</label>
                            <input type="text" class="form-control" id="editSupplierName" name="supplier_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editContactName" class="form-label">Nama Kontak</label>
                            <input type="text" class="form-control" id="editContactName" name="contact_name">
                        </div>
                        <div class="mb-3">
                            <label for="editPhoneNumber" class="form-label">Nomor Telepon</label>
                            <input type="text" class="form-control" id="editPhoneNumber" name="phone_number">
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Alamat</label>
                            <textarea class="form-control" id="editAddress" name="address"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Riwayat Barang Masuk -->
    <div class="modal fade" id="addGoodsInModal" tabindex="-1" aria-labelledby="addGoodsInModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addGoodsInModalLabel">Tambah Riwayat Barang Masuk Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <form id="addGoodsInForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addGoodsInSupplierId" class="form-label">Supplier ID</label>
                            <input type="text" class="form-control" id="addGoodsInSupplierId" name="supplier_id" required>
                        </div>
                        <div class="mb-3">
                            <label for="addGoodsInProductId" class="form-label">Product ID</label>
                            <input type="text" class="form-control" id="addGoodsInProductId" name="product_id" required>
                        </div>
                        <div class="mb-3">
                            <label for="addGoodsInArrivedDate" class="form-label">Tanggal Tiba</label>
                            <input type="date" class="form-control" id="addGoodsInArrivedDate" name="arrived_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="addGoodsInQuantity" class="form-label">Kuantitas</label>
                            <input type="number" class="form-control" id="addGoodsInQuantity" name="quantity" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="addGoodsInUnitPrice" class="form-label">Harga Satuan saat Tiba (IDR)</label>
                            <input type="number" class="form-control" id="addGoodsInUnitPrice" name="unit_price_at_arrival" required min="0" step="0.01">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Edit Riwayat Barang Masuk -->
    <div class="modal fade" id="editGoodsInModal" tabindex="-1" aria-labelledby="editGoodsInModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editGoodsInModalLabel">Edit Riwayat Barang Masuk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <form id="editGoodsInForm">
                    <div class="modal-body">
                        <input type="hidden" id="editGoodsInId" name="goods_in_id">
                        <div class="mb-3">
                            <label for="editGoodsInSupplierId" class="form-label">Supplier ID</label>
                            <input type="text" class="form-control" id="editGoodsInSupplierId" name="supplier_id" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGoodsInProductId" class="form-label">Product ID</label>
                            <input type="text" class="form-control" id="editGoodsInProductId" name="product_id" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGoodsInArrivedDate" class="form-label">Tanggal Tiba</label>
                            <input type="date" class="form-control" id="editGoodsInArrivedDate" name="arrived_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGoodsInQuantity" class="form-label">Kuantitas</label>
                            <input type="number" class="form-control" id="editGoodsInQuantity" name="quantity" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="editGoodsInUnitPrice" class="form-label">Harga Satuan saat Tiba (IDR)</label>
                            <input type="number" class="form-control" id="editGoodsInUnitPrice" name="unit_price_at_arrival" required min="0" step="0.01">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        const sidebarLinks = sidebar.querySelectorAll('ul li a');

        function openSidebar() {
            sidebar.classList.add('active');
            hamburgerBtn.setAttribute('aria-expanded', 'true');
            hamburgerBtn.setAttribute('data-tooltip', 'Close Sidebar');
        }

        function closeSidebar() {
            sidebar.classList.remove('active');
            hamburgerBtn.setAttribute('aria-expanded', 'false');
            hamburgerBtn.setAttribute('data-tooltip', 'Open Sidebar');
        }

        hamburgerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openSidebar();
        });

        sidebarBackdrop.addEventListener('click', () => {
            closeSidebar();
        });

        sidebarLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (sidebar.classList.contains('active')) {
                    closeSidebar();
                }
            });
        });

        // --- Fungsi untuk mengambil dan mengisi data tabel ---

        // Fungsi untuk mengambil dan mengisi tabel pemasok
        async function fetchAndPopulateSuppliers() {
            const searchTerm = document.getElementById('supplierSearchInput').value; // Ambil nilai pencarian
            try {
                // Buat URL dengan parameter pencarian
                const url = `supapi.php?action=getSuppliers&searchTerm=${encodeURIComponent(searchTerm)}`;
                const response = await fetch(url);
                const data = await response.json();

                const tableBody = document.getElementById('suppliersTableBody');
                tableBody.innerHTML = ''; // Hapus baris yang ada

                if (data.status === 'success' && Array.isArray(data.data)) {
                    if (data.data.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Tidak ada data pemasok ditemukan.</td></tr>`;
                    } else {
                        data.data.forEach(supplier => {
                            const row = tableBody.insertRow();
                            row.insertCell().textContent = supplier.supplier_id;
                            row.insertCell().textContent = supplier.supplier_name;
                            row.insertCell().textContent = supplier.contact_name;
                            row.insertCell().textContent = supplier.phone_number;
                            row.insertCell().textContent = supplier.address;
                            
                            const actionCell = row.insertCell();
                            actionCell.innerHTML = `
                                <button class="btn btn-sm btn-outline-primary edit-supplier-btn" data-bs-toggle="modal" data-bs-target="#editSupplierModal">Edit</button>
                                <button class="btn btn-sm btn-outline-danger delete-supplier-btn">Hapus</button>
                            `;

                            // Simpan data supplier di atribut dataset baris untuk akses mudah saat edit/hapus
                            row.dataset.supplier = JSON.stringify(supplier);
                        });
                    }
                } else {
                    console.error('Error mengambil pemasok:', data.message);
                    tableBody.innerHTML = `<tr><td colspan="6">Error memuat data: ${data.message || 'Terjadi kesalahan tidak dikenal'}</td></tr>`;
                }
            } catch (error) {
                console.error('Error jaringan atau parsing untuk pemasok:', error);
                document.getElementById('suppliersTableBody').innerHTML = `<tr><td colspan="6">Gagal memuat data pemasok. Silakan periksa jaringan Anda.</td></tr>`;
            }
        }

        // Fungsi untuk mengambil dan mengisi tabel riwayat barang masuk
        async function fetchAndPopulateGoodsInHistory() {
            const productSearchTerm = document.getElementById('goodsInProductSearchInput').value;
            const dateFilter = document.getElementById('goodsInDateFilter').value;
            const supplierIdFilter = document.getElementById('goodsInSupplierFilter').value;

            try {
                // Buat URL dengan semua parameter filter
                const url = `supapi.php?action=getGoodsInHistory&productSearchTerm=${encodeURIComponent(productSearchTerm)}&dateFilter=${encodeURIComponent(dateFilter)}&supplierIdFilter=${encodeURIComponent(supplierIdFilter)}`;
                const response = await fetch(url);
                const data = await response.json();

                const tableBody = document.getElementById('goodsInHistoryTableBody');
                tableBody.innerHTML = ''; // Hapus baris yang ada

                if (data.status === 'success' && Array.isArray(data.data)) {
                    if (data.data.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="9" class="text-center">Tidak ada riwayat barang masuk ditemukan.</td></tr>`;
                    } else {
                        data.data.forEach(item => {
                            const row = tableBody.insertRow();
                            row.insertCell().textContent = item.goods_in_id;
                            row.insertCell().textContent = item.supplier_id;
                            row.insertCell().textContent = item.product_id;
                            row.insertCell().textContent = item.product_name;
                            row.insertCell().textContent = item.arrived_date;
                            row.insertCell().textContent = item.quantity;
                            // Format harga sebagai mata uang IDR
                            row.insertCell().textContent = parseFloat(item.unit_price_at_arrival).toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
                            row.insertCell().textContent = parseFloat(item.total_cost).toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });

                            const actionCell = row.insertCell();
                            actionCell.innerHTML = `
                                <button class="btn btn-sm btn-outline-primary edit-goods-in-btn" data-bs-toggle="modal" data-bs-target="#editGoodsInModal">Edit</button>
                                <button class="btn btn-sm btn-outline-danger delete-goods-in-btn">Hapus</button>
                            `;

                            // Simpan data barang masuk di atribut dataset baris untuk akses mudah
                            row.dataset.goodsIn = JSON.stringify(item);
                        });
                    }
                } else {
                    console.error('Error mengambil riwayat barang masuk:', data.message);
                    tableBody.innerHTML = `<tr><td colspan="9">Error memuat data: ${data.message || 'Terjadi kesalahan tidak dikenal'}</td></tr>`;
                }
            } catch (error) {
                console.error('Error jaringan atau parsing untuk riwayat barang masuk:', error);
                document.getElementById('goodsInHistoryTableBody').innerHTML = `<tr><td colspan="9">Gagal memuat data riwayat barang masuk. Silakan periksa jaringan Anda.</td></tr>`;
            }
        }

        // Fungsi untuk mengisi dropdown filter Supplier ID
        async function populateSupplierFilterDropdown() {
            try {
                const response = await fetch('supapi.php?action=getSupplierIds');
                const data = await response.json();
                const selectElement = document.getElementById('goodsInSupplierFilter');

                // Hapus opsi yang ada, biarkan opsi default "Filter berdasarkan Supplier ID"
                selectElement.innerHTML = '<option value="">Filter berdasarkan Supplier ID</option>';

                if (data.status === 'success' && Array.isArray(data.data)) {
                    data.data.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.supplier_id;
                        option.textContent = `${supplier.supplier_id} - ${supplier.supplier_name}`;
                        selectElement.appendChild(option);
                    });
                } else {
                    console.error('Error mengambil ID pemasok untuk dropdown:', data.message);
                }
            } catch (error) {
                console.error('Error jaringan atau parsing untuk dropdown ID pemasok:', error);
            }
        }

        // --- Event Listener dan Pengiriman Form ---

        // Event listener untuk pencarian pemasok
        document.getElementById('supplierSearchInput').addEventListener('input', () => {
            fetchAndPopulateSuppliers();
        });

        // Event listener untuk pengiriman form Tambah Supplier
        document.getElementById('addSupplierForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Mencegah refresh halaman
            const formData = new FormData(event.target);
            const supplierData = Object.fromEntries(formData.entries()); // Ubah data form menjadi objek JSON

            try {
                const response = await fetch('supapi.php?action=addSupplier', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Beri tahu server bahwa kita mengirim JSON
                    },
                    body: JSON.stringify(supplierData) // Kirim data sebagai string JSON
                });
                const data = await response.json(); // Parse respons JSON dari server
                if (data.status === 'success') {
                    alert('Pemasok berhasil ditambahkan!');
                    // Tutup modal menggunakan objek Modal Bootstrap
                    const addModal = bootstrap.Modal.getInstance(document.getElementById('addSupplierModal')) || new bootstrap.Modal(document.getElementById('addSupplierModal'));
                    addModal.hide();
                    event.target.reset(); // Kosongkan form
                    fetchAndPopulateSuppliers(); // Perbarui tabel pemasok
                    populateSupplierFilterDropdown(); // Perbarui dropdown filter supplier
                } else {
                    alert('Error menambahkan pemasok: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Gagal menambahkan pemasok. Silakan periksa jaringan dan server.');
            }
        });

        // Event listener untuk tombol Edit Supplier (delegasi event)
        document.getElementById('suppliersTableBody').addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-supplier-btn')) {
                const row = event.target.closest('tr');
                const supplier = JSON.parse(row.dataset.supplier); // Ambil data supplier dari dataset baris

                // Isi form modal edit dengan data supplier yang dipilih
                document.getElementById('editSupplierOriginalId').value = supplier.supplier_id; // ID asli untuk disimpan
                document.getElementById('editSupplierId').value = supplier.supplier_id; // Untuk ditampilkan, tapi dinonaktifkan
                document.getElementById('editSupplierName').value = supplier.supplier_name;
                document.getElementById('editContactName').value = supplier.contact_name;
                document.getElementById('editPhoneNumber').value = supplier.phone_number;
                document.getElementById('editAddress').value = supplier.address;
            }
        });

        // Event listener untuk pengiriman form Edit Supplier
        document.getElementById('editSupplierForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const originalSupplierId = document.getElementById('editSupplierOriginalId').value;
            const formData = new FormData(event.target);
            const supplierData = Object.fromEntries(formData.entries());
            supplierData.supplier_id = originalSupplierId; // Gunakan ID asli untuk query update

            try {
                const response = await fetch('supapi.php?action=editSupplier', {
                    method: 'POST', // Menggunakan POST untuk kesederhanaan, bisa juga PUT
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(supplierData)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Pemasok berhasil diperbarui!');
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editSupplierModal')) || new bootstrap.Modal(document.getElementById('editSupplierModal'));
                    editModal.hide();
                    fetchAndPopulateSuppliers(); // Perbarui tabel
                    populateSupplierFilterDropdown(); // Perbarui dropdown filter supplier
                } else {
                    alert('Error memperbarui pemasok: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Gagal memperbarui pemasok. Silakan periksa jaringan dan server.');
            }
        });

        // Event listener untuk tombol Hapus Supplier (delegasi event)
        document.getElementById('suppliersTableBody').addEventListener('click', async (event) => {
            if (event.target.classList.contains('delete-supplier-btn')) {
                const row = event.target.closest('tr');
                const supplier = JSON.parse(row.dataset.supplier);

                if (confirm(`Apakah Anda yakin ingin menghapus pemasok "${supplier.supplier_name}" (ID: ${supplier.supplier_id})? Tindakan ini tidak dapat dibatalkan.`)) {
                    try {
                        const response = await fetch('supapi.php?action=deleteSupplier', {
                            method: 'POST', // Menggunakan POST untuk kesederhanaan, bisa juga DELETE
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ supplier_id: supplier.supplier_id }) // Kirim ID supplier yang akan dihapus
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            alert('Pemasok berhasil dihapus!');
                            fetchAndPopulateSuppliers(); // Perbarui tabel
                            populateSupplierFilterDropdown(); // Perbarui dropdown filter supplier
                        } else {
                            alert('Error menghapus pemasok: ' + data.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Gagal menghapus pemasok. Silakan periksa jaringan dan server.');
                    }
                }
            }
        });

        // Event listener untuk pencarian produk riwayat barang masuk
        document.getElementById('goodsInProductSearchInput').addEventListener('input', () => {
            fetchAndPopulateGoodsInHistory();
        });
        // Event listener untuk filter tanggal riwayat barang masuk
        document.getElementById('goodsInDateFilter').addEventListener('change', () => {
            fetchAndPopulateGoodsInHistory();
        });
        // Event listener untuk filter supplier riwayat barang masuk
        document.getElementById('goodsInSupplierFilter').addEventListener('change', () => {
            fetchAndPopulateGoodsInHistory();
        });

        // Event listener untuk pengiriman form Tambah Riwayat Barang Masuk
        document.getElementById('addGoodsInForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const goodsIn = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('supapi.php?action=addGoodsInHistory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(goodsIn)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Riwayat barang masuk berhasil ditambahkan!');
                    const addGoodsInModal = bootstrap.Modal.getInstance(document.getElementById('addGoodsInModal')) || new bootstrap.Modal(document.getElementById('addGoodsInModal'));
                    addGoodsInModal.hide();
                    event.target.reset();
                    fetchAndPopulateGoodsInHistory(); // Perbarui tabel
                } else {
                    alert('Error menambahkan riwayat barang masuk: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Gagal menambahkan riwayat barang masuk. Silakan periksa jaringan dan server.');
            }
        });

        // Event listener untuk tombol Edit Riwayat Barang Masuk (delegasi event)
        document.getElementById('goodsInHistoryTableBody').addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-goods-in-btn')) {
                const row = event.target.closest('tr');
                const goodsIn = JSON.parse(row.dataset.goodsIn);

                // Isi form modal edit dengan data barang masuk yang dipilih
                document.getElementById('editGoodsInId').value = goodsIn.goods_in_id;
                document.getElementById('editGoodsInSupplierId').value = goodsIn.supplier_id;
                document.getElementById('editGoodsInProductId').value = goodsIn.product_id;
                document.getElementById('editGoodsInArrivedDate').value = goodsIn.arrived_date;
                document.getElementById('editGoodsInQuantity').value = goodsIn.quantity;
                document.getElementById('editGoodsInUnitPrice').value = goodsIn.unit_price_at_arrival;
            }
        });

        // Event listener untuk pengiriman form Edit Riwayat Barang Masuk
        document.getElementById('editGoodsInForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const goodsInId = document.getElementById('editGoodsInId').value;
            const formData = new FormData(event.target);
            const goodsIn = Object.fromEntries(formData.entries());
            goodsIn.goods_in_id = goodsInId; // Pastikan ID barang masuk ada di data yang dikirim

            try {
                const response = await fetch('supapi.php?action=editGoodsInHistory', {
                    method: 'POST', // Menggunakan POST untuk kesederhanaan
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(goodsIn)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Riwayat barang masuk berhasil diperbarui!');
                    const editGoodsInModal = bootstrap.Modal.getInstance(document.getElementById('editGoodsInModal')) || new bootstrap.Modal(document.getElementById('editGoodsInModal'));
                    editGoodsInModal.hide();
                    fetchAndPopulateGoodsInHistory(); // Perbarui tabel
                } else {
                    alert('Error memperbarui riwayat barang masuk: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Gagal memperbarui riwayat barang masuk. Silakan periksa jaringan dan server.');
            }
        });

        // Event listener untuk tombol Hapus Riwayat Barang Masuk (delegasi event)
        document.getElementById('goodsInHistoryTableBody').addEventListener('click', async (event) => {
            if (event.target.classList.contains('delete-goods-in-btn')) {
                const row = event.target.closest('tr');
                const goodsIn = JSON.parse(row.dataset.goodsIn);

                if (confirm(`Apakah Anda yakin ingin menghapus catatan riwayat barang masuk ID: ${goodsIn.goods_in_id} (Produk: ${goodsIn.product_name})? Ini juga akan menyesuaikan inventaris.`)) {
                    try {
                        const response = await fetch('supapi.php?action=deleteGoodsInHistory', {
                            method: 'POST', // Menggunakan POST untuk kesederhanaan
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ goods_in_id: goodsIn.goods_in_id })
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            alert('Riwayat barang masuk berhasil dihapus dan inventaris disesuaikan!');
                            fetchAndPopulateGoodsInHistory(); // Perbarui tabel
                        } else {
                            alert('Error menghapus riwayat barang masuk: ' + data.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Gagal menghapus riwayat barang masuk. Silakan periksa jaringan dan server.');
                    }
                }
            }
        });


        // Panggilan awal saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndPopulateSuppliers(); // Muat data pemasok
            fetchAndPopulateGoodsInHistory(); // Muat data riwayat barang masuk
            populateSupplierFilterDropdown(); // Isi dropdown filter supplier
        });
    </script>
</body>
</html>
